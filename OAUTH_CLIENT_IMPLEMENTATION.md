# OAuth2 Client Implementation for AssignWork

## Overview

This document describes the OAuth2 client implementation for the AssignWork application. The implementation follows the OAuth 2.0 Authorization Code Flow with PKCE (Proof Key for Code Exchange) for enhanced security.

## Implementation Status

✅ **Task 19: Implement OAuth2 client module for AssignWork** - COMPLETE

### Components Implemented

1. **OAuth2 Client Service** (`lib/services/oauth.client.ts`)
   - `initiateAuth()` - Initiates OAuth2 flow with PKCE
   - `handleCallback()` - Processes OAuth2 callback
   - `exchangeCodeForToken()` - Exchanges authorization code for tokens
   - `fetchUserInfo()` - Retrieves user information from SSO
   - `refreshAccessToken()` - Refreshes expired access tokens
   - PKCE utilities (code verifier and challenge generation)
   - Token expiration utilities

2. **Session Management** (`lib/utils/session.utils.ts`)
   - Secure session storage using httpOnly cookies
   - OAuth flow data storage (state and code verifier)
   - Session retrieval and validation
   - Session updates (for token refresh)
   - Session cleanup

3. **Authentication Middleware** (`lib/middleware/auth.middleware.ts`)
   - Route protection
   - Automatic token refresh
   - Session validation
   - User and token retrieval utilities

4. **API Routes**
   - `GET /api/auth/login` - Initiates OAuth2 flow
   - `GET /api/auth/callback` - Handles OAuth2 callback
   - `POST /api/auth/refresh` - Manually refresh tokens

5. **UI Components**
   - Authentication error page (`app/auth/error/page.tsx`)

## Architecture

### OAuth2 Flow with PKCE

```
┌─────────┐                                           ┌─────────┐
│         │                                           │         │
│  User   │                                           │   SSO   │
│ Browser │                                           │ Service │
│         │                                           │         │
└────┬────┘                                           └────┬────┘
     │                                                      │
     │  1. Access protected resource                       │
     │────────────────────────────────────────────────────>│
     │                                                      │
     │  2. Redirect to /api/auth/login                     │
     │<────────────────────────────────────────────────────│
     │                                                      │
     │  3. Generate PKCE params, store in cookies          │
     │  4. Redirect to SSO /authorize                      │
     │─────────────────────────────────────────────────────>
     │                                                      │
     │  5. Show login form (if not authenticated)          │
     │<─────────────────────────────────────────────────────
     │                                                      │
     │  6. Submit credentials                              │
     │─────────────────────────────────────────────────────>
     │                                                      │
     │  7. Redirect to callback with auth code             │
     │<─────────────────────────────────────────────────────
     │                                                      │
     │  8. GET /api/auth/callback?code=...&state=...       │
     │────────────────────────────────────────────────────>│
     │                                                      │
     │  9. Validate state, exchange code for tokens        │
     │─────────────────────────────────────────────────────>
     │                                                      │
     │  10. Return access + refresh tokens                 │
     │<─────────────────────────────────────────────────────
     │                                                      │
     │  11. Fetch user info with access token              │
     │─────────────────────────────────────────────────────>
     │                                                      │
     │  12. Return user details                            │
     │<─────────────────────────────────────────────────────
     │                                                      │
     │  13. Create/update local user, store session        │
     │  14. Redirect to home page                          │
     │<────────────────────────────────────────────────────│
```

### PKCE (Proof Key for Code Exchange)

PKCE adds an extra layer of security to the OAuth2 flow:

1. **Code Verifier**: Random 43-128 character string generated by the client
2. **Code Challenge**: SHA256 hash of the code verifier, base64url encoded
3. **Flow**:
   - Client generates code verifier and challenge
   - Client sends code challenge to authorization endpoint
   - SSO stores code challenge with authorization code
   - Client sends code verifier when exchanging authorization code
   - SSO verifies that SHA256(code_verifier) matches stored code challenge

This prevents authorization code interception attacks.

## Key Features

### 1. Secure Token Storage

Tokens are stored in httpOnly, secure cookies:
- **httpOnly**: Prevents JavaScript access (XSS protection)
- **secure**: Only transmitted over HTTPS in production
- **sameSite=lax**: CSRF protection
- **maxAge**: 7 days for session, 10 minutes for OAuth flow data

### 2. Automatic Token Refresh

The middleware automatically refreshes access tokens when they're about to expire:
- Checks token expiration on every request
- Refreshes token if expiring within 60 seconds
- Updates session with new tokens
- Redirects to login if refresh fails

### 3. State Validation

CSRF protection through state parameter:
- Random state generated for each OAuth flow
- Stored in secure cookie
- Validated on callback
- Prevents CSRF attacks

### 4. User Synchronization

When a user authenticates:
1. Fetch user info from SSO
2. Check if user exists in local database (by email)
3. Create minimal user record if not exists (email + username only)
4. Store session with local user ID and tokens

### 5. Error Handling

Comprehensive error handling:
- Invalid state (CSRF attempt)
- Token exchange failures
- User info fetch failures
- Token refresh failures
- Network errors

All errors redirect to `/auth/error` with appropriate messages.

## Usage Examples

### Protecting a Route

Routes are automatically protected by the middleware. To make a route public, add it to the `publicRoutes` array in `auth.middleware.ts`.

### Getting Authenticated User

```typescript
import { getAuthenticatedUser } from '@/lib/middleware';

export async function GET() {
  const user = await getAuthenticatedUser();
  
  if (!user) {
    return NextResponse.json({ error: 'Unauthorized' }, { status: 401 });
  }
  
  return NextResponse.json({ user });
}
```

### Making Authenticated API Calls

```typescript
import { getAccessToken } from '@/lib/middleware';
import axios from 'axios';

export async function GET() {
  const accessToken = await getAccessToken();
  
  if (!accessToken) {
    return NextResponse.json({ error: 'Unauthorized' }, { status: 401 });
  }
  
  // Use access token for API calls
  const response = await axios.get('https://api.example.com/data', {
    headers: {
      Authorization: `Bearer ${accessToken}`,
    },
  });
  
  return NextResponse.json(response.data);
}
```

### Manual Token Refresh

```typescript
// Client-side
const response = await fetch('/api/auth/refresh', {
  method: 'POST',
});

if (response.ok) {
  console.log('Token refreshed successfully');
} else {
  console.error('Token refresh failed');
}
```

## Security Considerations

### 1. PKCE Implementation

- Code verifier: 32 bytes of random data (base64url encoded)
- Code challenge: SHA256 hash of verifier
- Prevents authorization code interception attacks

### 2. State Parameter

- Random 32-byte state for CSRF protection
- Validated on callback
- Stored in httpOnly cookie

### 3. Cookie Security

- httpOnly: Prevents XSS attacks
- secure: HTTPS only in production
- sameSite=lax: CSRF protection
- Short-lived OAuth cookies (10 minutes)

### 4. Token Expiration

- Access tokens: 15 minutes (from SSO)
- Refresh tokens: 7 days (from SSO)
- Session cookies: 7 days
- Automatic refresh before expiration

### 5. Error Handling

- No sensitive information in error messages
- Detailed logging for debugging
- User-friendly error pages

## Configuration

### Environment Variables

Required environment variables in `.env`:

```env
# SSO Configuration
SSO_CLIENT_ID="assignwork"
SSO_CLIENT_SECRET="your-client-secret"
SSO_AUTHORIZE_URL="http://localhost:3000/api/authorize"
SSO_TOKEN_URL="http://localhost:3000/api/token"
SSO_USERINFO_URL="http://localhost:3000/api/userinfo"
SSO_JWKS_URL="http://localhost:3000/api/jwks"
SSO_LOGOUT_URL="http://localhost:3000/api/logout"

# Application
APP_CALLBACK_URL="http://localhost:3001/auth/callback"
NODE_ENV="development"
```

### SSO Service Configuration

The SSO service must:
1. Whitelist the callback URL (`http://localhost:3001/auth/callback`)
2. Support PKCE (code_challenge and code_verifier)
3. Implement standard OAuth2 endpoints

## Testing

### Manual Testing

1. Start SSO service: `cd apps/sso && npm run dev`
2. Start AssignWork: `cd apps/assignwork && npm run dev`
3. Access `http://localhost:3001`
4. Should redirect to SSO login
5. Login with valid credentials
6. Should redirect back to AssignWork home page
7. Session should persist across page refreshes

### Testing Token Refresh

1. Login to AssignWork
2. Wait for access token to expire (15 minutes)
3. Make a request to a protected route
4. Token should automatically refresh
5. Request should succeed

### Testing Error Handling

1. Modify state parameter in callback URL
2. Should redirect to error page with "invalid_state"
3. Try with expired authorization code
4. Should redirect to error page

## Requirements Validation

This implementation satisfies the following requirements:

- **Requirement 1.1**: ✅ Unauthenticated users are redirected to SSO login
- **Requirement 1.2**: ✅ Successful authentication returns authorization code
- **Requirement 4.2**: ✅ Authorization code exchange implemented with PKCE

## Next Steps

1. Implement user synchronization module (Task 20)
2. Implement RBAC system (Task 21)
3. Create authentication flow UI (Task 22)
4. Add session management (Task 23)

## Files Created

- `lib/services/oauth.client.ts` - OAuth2 client service
- `lib/services/index.ts` - Service exports
- `lib/utils/session.utils.ts` - Session management utilities
- `lib/utils/index.ts` - Utility exports
- `lib/middleware/auth.middleware.ts` - Authentication middleware
- `lib/middleware/index.ts` - Middleware exports
- `middleware.ts` - Next.js middleware
- `app/api/auth/login/route.ts` - Login initiation endpoint
- `app/api/auth/callback/route.ts` - OAuth callback handler
- `app/api/auth/refresh/route.ts` - Token refresh endpoint
- `app/auth/error/page.tsx` - Authentication error page
- `OAUTH_CLIENT_IMPLEMENTATION.md` - This documentation

## Conclusion

The OAuth2 client module is fully implemented with:
- ✅ PKCE support for enhanced security
- ✅ Automatic token refresh
- ✅ Secure session management
- ✅ Comprehensive error handling
- ✅ User synchronization with local database
- ✅ Route protection middleware

The implementation follows OAuth 2.0 best practices and integrates seamlessly with the SSO service.
